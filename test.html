<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>V2rayMiner - نسخه نهایی</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap"
      rel="stylesheet" />

    <style>
      body {
        font-family: "Vazirmatn", sans-serif;
        overflow: hidden; /* Prevents scrollbars from the background shapes */
      }
      .aurora-shape {
        position: absolute;
        filter: blur(100px);
        border-radius: 50%;
        z-index: -1;
        animation: pulse 20s infinite alternate;
      }
      @keyframes pulse {
        0% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        100% {
          transform: scale(1.2);
          opacity: 0.8;
        }
      }
      .transition-all-fast {
        transition: all 0.2s ease-in-out;
      }
      .output-container {
        max-height: 0;
        overflow: hidden;
      }
      .output-container.show {
        max-height: 500px;
      }
    </style>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "theme-primary": "#a29283",
              "theme-secondary": "#c8bbae",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-900 min-h-screen flex items-center justify-center p-4">
    <div class="aurora-shape w-96 h-96 bg-theme-primary/50 top-[-10%] left-[-5%]"></div>
    <div
      class="aurora-shape w-96 h-96 bg-theme-secondary/50 bottom-[-10%] right-[-5%]"
      style="animation-delay: 5s"></div>
    <div
      class="aurora-shape w-72 h-72 bg-blue-500/30 bottom-[20%] left-[20%]"
      style="animation-delay: 10s"></div>

    <div
      class="w-full max-w-3xl mx-auto bg-white/10 backdrop-blur-xl text-white rounded-2xl shadow-2xl border border-white/20 overflow-hidden">
      <div class="p-6 md:p-8 text-center border-b border-white/10">
        <h1 class="text-3xl md:text-4xl font-black">V2rayMiner</h1>
        <p class="text-white/60 mt-2">ابزار هوشمند کانفیگ</p>
      </div>

      <div class="p-6 md:p-8 space-y-8">
        <div class="space-y-6">
          <textarea
            id="configInput"
            rows="7"
            class="w-full p-4 bg-black/30 border-2 border-white/20 rounded-lg outline-none transition-all-fast focus:ring-2 focus:ring-theme-secondary/60 focus:border-theme-secondary/80 placeholder:text-white/40"
            placeholder="کانفیگ‌ها را اینجا جای‌گذاری کنید..."></textarea>

          <fieldset class="border border-white/20 rounded-lg p-4">
            <legend class="px-2 text-sm text-white/70">
              یا از روش‌های دیگر استفاده کنید:
            </legend>
            <div class="flex flex-col md:flex-row gap-4 pt-2">
              <label
                for="fileInput"
                class="flex-1 cursor-pointer bg-white/10 border border-white/20 px-4 py-2.5 rounded-lg hover:bg-white/20 transition-all-fast text-center font-semibold flex items-center justify-center gap-2">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                بارگذاری فایل
                <input type="file" id="fileInput" class="hidden" />
              </label>
              <div class="flex-1 flex gap-2">
                <input
                  type="url"
                  id="urlInput"
                  class="w-full px-3 bg-black/30 border-2 border-white/20 rounded-lg outline-none transition-all-fast focus:ring-2 focus:ring-theme-secondary/60 focus:border-theme-secondary/80 placeholder:text-white/40"
                  placeholder="لینک مستقیم فایل متنی" />
                <button
                  id="fetchUrlButton"
                  class="p-2.5 bg-white/10 border border-white/20 rounded-lg hover:bg-white/20 transition-all-fast disabled:opacity-50 disabled:cursor-wait">
                  <svg
                    id="fetchIcon"
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  <svg
                    id="loadingIcon"
                    class="w-5 h-5 animate-spin hidden"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24">
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </fieldset>
        </div>

        <input
          type="text"
          id="newNameInput"
          class="w-full p-4 bg-black/30 border-2 border-white/20 rounded-lg outline-none transition-all-fast focus:ring-2 focus:ring-theme-secondary/60 focus:border-theme-secondary/80 placeholder:text-white/40"
          placeholder="نام جدید مورد نظر" />

        <button
          id="processButton"
          class="w-full bg-gradient-to-r from-theme-primary to-theme-secondary text-white font-bold py-3.5 px-4 rounded-lg hover:scale-105 active:scale-100 transition-all-fast text-lg shadow-lg shadow-theme-primary/20">
          تغییر نام کانفیگ‌ها
        </button>

        <div
          id="outputSection"
          class="output-container opacity-0 transition-all duration-500 ease-in-out">
          <div class="pt-6 border-t border-white/10 space-y-4">
            <textarea
              id="outputBox"
              rows="7"
              readonly
              class="w-full p-4 bg-black/30 border-2 border-white/20 rounded-lg outline-none focus:ring-2 focus:ring-theme-secondary/60 cursor-text"></textarea>
            <div class="flex flex-col md:flex-row gap-4">
              <button
                id="copyButton"
                class="flex-1 bg-white/20 backdrop-blur-sm font-semibold py-2.5 px-4 rounded-lg hover:bg-white/30 active:scale-95 transition-all-fast">
                کپی
              </button>
              <button
                id="downloadButton"
                class="flex-1 bg-white/20 backdrop-blur-sm font-semibold py-2.5 px-4 rounded-lg hover:bg-white/30 active:scale-95 transition-all-fast">
                دانلود
              </button>
            </div>
            <div
              id="successMessage"
              class="text-center h-5 text-green-400 font-semibold opacity-0 transition-all-fast"></div>
          </div>
        </div>
        <button
          id="clearButton"
          class="w-full text-white/50 hover:text-white transition-all-fast text-sm font-semibold">
          پاک کردن همه
        </button>
      </div>
    </div>

    <script>
      // DOM Elements
      const el = {
        configInput: document.getElementById("configInput"),
        fileInput: document.getElementById("fileInput"),
        urlInput: document.getElementById("urlInput"),
        fetchUrlButton: document.getElementById("fetchUrlButton"),
        fetchIcon: document.getElementById("fetchIcon"),
        loadingIcon: document.getElementById("loadingIcon"),
        newNameInput: document.getElementById("newNameInput"),
        processButton: document.getElementById("processButton"),
        clearButton: document.getElementById("clearButton"),
        outputSection: document.getElementById("outputSection"),
        outputBox: document.getElementById("outputBox"),
        copyButton: document.getElementById("copyButton"),
        downloadButton: document.getElementById("downloadButton"),
        successMessage: document.getElementById("successMessage"),
      };
      let processedContent = "";

      // Event Listeners
      el.fileInput.addEventListener("change", handleFileUpload);
      el.fetchUrlButton.addEventListener("click", handleUrlFetch);
      el.clearButton.addEventListener("click", clearAll);
      el.processButton.addEventListener("click", processAndShow);
      el.copyButton.addEventListener("click", copyToClipboard);
      el.downloadButton.addEventListener("click", downloadResultFile);

      function setLoadingState(isLoading) {
        el.fetchUrlButton.disabled = isLoading;
        el.fetchIcon.classList.toggle("hidden", isLoading);
        el.loadingIcon.classList.toggle("hidden", !isLoading);
      }

      async function handleUrlFetch() {
        const url = el.urlInput.value.trim();
        if (!url) {
          alert("لطفاً یک لینک معتبر وارد کنید.");
          return;
        }
        setLoadingState(true);

        // *** CHANGE IS HERE: Using a more reliable CORS proxy ***
        // We use allorigins.win which is a popular and stable service.
        // It needs the URL to be encoded to handle special characters.
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

        try {
          const response = await fetch(proxyUrl);
          if (!response.ok)
            throw new Error(`Network response was not ok: ${response.statusText}`);
          const data = await response.text();
          el.configInput.value = data;
          showSuccessMessage("محتوای لینک با موفقیت دریافت شد.");
        } catch (error) {
          console.error("Fetch Error:", error);
          alert(
            "دریافت محتوا از لینک با خطا مواجه شد. لطفاً از صحت لینک اطمینان حاصل کنید."
          );
        } finally {
          setLoadingState(false);
        }
      }

      function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => (el.configInput.value = e.target.result);
        reader.readAsText(file);
      }
      function clearAll() {
        el.configInput.value = "";
        el.newNameInput.value = "";
        el.urlInput.value = "";
        processedContent = "";
        el.outputBox.value = "";
        hideOutputSection();
      }
      function processAndShow() {
        const configs = el.configInput.value.trim();
        const newName = el.newNameInput.value.trim();
        if (!configs || !newName) {
          alert("لطفاً ورودی کانفیگ‌ها و نام جدید را پر کنید.");
          return;
        }
        processedContent = configs
          .split(/\r?\n/)
          .map((line) => {
            const trimmedLine = line.trim();
            if (!trimmedLine || !trimmedLine.match(/^(vmess|vless|trojan|ss|ssr):\/\//))
              return null;
            const hashIndex = trimmedLine.lastIndexOf("#");
            const baseConfig =
              hashIndex !== -1 ? trimmedLine.substring(0, hashIndex) : trimmedLine;
            return `${baseConfig}#${encodeURIComponent(newName)}`;
          })
          .filter(Boolean)
          .join("\n");
        el.outputBox.value = processedContent;
        showOutputSection();
      }
      function copyToClipboard() {
        if (!processedContent) return;
        navigator.clipboard.writeText(processedContent).then(
          () => {
            showSuccessMessage("با موفقیت کپی شد!");
          },
          () => {
            showSuccessMessage("خطا در کپی کردن!", true);
          }
        );
      }
      function downloadResultFile() {
        if (!processedContent) return;
        const newName = el.newNameInput.value.trim() || "renamed";
        const blob = new Blob([processedContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `V2rayMiner-${newName}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showSuccessMessage("فایل برای دانلود آماده شد!");
      }
      function showOutputSection() {
        el.outputSection.classList.add("show", "opacity-100");
      }
      function hideOutputSection() {
        el.outputSection.classList.remove("show", "opacity-100");
        showSuccessMessage("", true);
      }
      let messageTimeout;
      function showSuccessMessage(message, isError = false) {
        clearTimeout(messageTimeout);
        el.successMessage.textContent = message;
        el.successMessage.className = `text-center h-5 font-semibold transition-all-fast ${
          isError ? "text-red-400" : "text-green-400"
        } opacity-100`;
        messageTimeout = setTimeout(() => {
          el.successMessage.classList.remove("opacity-100");
        }, 3000);
      }
    </script>
  </body>
</html>
